<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nairobi Distillers Stock Management</title>
<style>
body { font-family: Arial,sans-serif; background:#000; color:#fff; margin:0; padding:0;}
header { background:#111; padding:20px; text-align:center; font-size:28px; font-weight:bold; border-bottom:2px solid #444;}
.container { max-width:900px; margin:20px auto; padding:20px; background:#111; border-radius:10px; border:1px solid #333;}
h2 { border-left:4px solid white; padding-left:10px; margin-top:20px;}
form { display:grid; grid-template-columns:1fr 1fr; gap:15px;}
input, select, button { padding:10px; border-radius:5px; border:none; width:100%;}
input, select { background:#222; color:#fff;}
button { background:#fff; color:#000; font-weight:bold; cursor:pointer; grid-column:span 2;}
table { width:100%; border-collapse:collapse; margin-top:20px;}
th, td { padding:12px; border:1px solid #333; text-align:left;}
th { background:#222;}
#recordsContainer { display:none;}
@media(max-width:600px){form{grid-template-columns:1fr;}button{grid-column:span 1;} table,th,td{font-size:14px;}}
</style>
</head>
<body>
<header>Nairobi Distillers | Stock Management</header>
<div class="container">

<h2>Add / Remove Stock</h2>
<form id="stockForm">
<input type="text" id="itemName" placeholder="Item" required>
<input type="number" id="quantity" placeholder="Quantity" required>
<input type="text" id="person" placeholder="Name" required>
<input type="text" id="purpose" placeholder="Purpose" required>
<select id="action" required>
<option value="add">Add to Stock</option>
<option value="remove">Remove from Stock</option>
</select>
<button type="submit">Submit</button>
</form>

<h2>Search Item Records</h2>
<input type="text" id="search" placeholder="Enter item name" style="width:100%;margin-bottom:10px;background:#222;color:white;padding:10px;border-radius:5px;">

<div id="recordsContainer">
<h2>Stock Records</h2>
<table>
<thead>
<tr><th>Qty</th><th>Action</th><th>Person</th><th>Purpose</th><th>Time</th></tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

<h2>Current Stock Balance</h2>
<table>
<thead><tr><th>Item</th><th>Balance</th><th>Actions</th></tr></thead>
<tbody id="balance"></tbody>
</table>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwcNfKfaPrkUQroizarLl0dt2wfHEWzD7AQmtav8WtwhYrBF2eaUIt5EPKhdDUzsJUUnw/exec";

const form = document.getElementById('stockForm');
const recordsTable = document.getElementById('records');
const recordsContainer = document.getElementById('recordsContainer');
const balanceTable = document.getElementById('balance');
const search = document.getElementById('search');

let stockData = [];
let recordsData = [];

// Fetch data from Google Sheets
async function loadData() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    stockData = data.stock.filter(s => s.item !== "item");
    recordsData = data.records.filter(r => r.item !== "item");
    refreshBalance();

    // Refresh search results if user is typing
    const q = search.value.toLowerCase().trim();
    if(q !== "") search.dispatchEvent(new Event('input'));
  } catch(e){
    console.error("Error loading data:", e);
  }
}

// Refresh balance table with Edit/Delete
function refreshBalance(){
  balanceTable.innerHTML = "";
  stockData.forEach((s, index) => {
    balanceTable.innerHTML += `<tr>
      <td>${s.item}</td>
      <td><input type="number" value="${s.balance}" data-index="${index}" style="width:70px;"></td>
      <td>
        <button data-action="edit" data-index="${index}">Edit</button>
        <button data-action="delete" data-index="${index}">Delete</button>
      </td>
    </tr>`;
  });

  balanceTable.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async function(){
      const idx = this.dataset.index;
      const item = stockData[idx].item;

      if(this.dataset.action === "edit"){
        const newValue = Number(balanceTable.querySelector(`input[data-index="${idx}"]`).value);
        const change = newValue - stockData[idx].balance;
        if(change === 0) return;
        const actionType = change > 0 ? 'add' : 'remove';

        await fetch(API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({
            item: item,
            qty: Math.abs(change),
            action: actionType,
            person: 'Admin',
            purpose: 'Edit balance'
          })
        });
        loadData();
      }

      if(this.dataset.action === "delete"){
        await fetch(API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({
            item: item,
            qty: stockData[idx].balance,
            action: 'remove',
            person: 'Admin',
            purpose: 'Delete item'
          })
        });
        loadData();
      }
    });
  });
}

// Submit new stock entry
form.addEventListener('submit', async function(e){
  e.preventDefault();
  const newItem = document.getElementById('itemName').value.trim();
  const newQty = Number(document.getElementById('quantity').value);
  const newPerson = document.getElementById('person').value.trim();
  const newPurpose = document.getElementById('purpose').value.trim();
  const newAction = document.getElementById('action').value;

  try {
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams({
        item:newItem,
        qty:newQty,
        action:newAction,
        person:newPerson,
        purpose:newPurpose
      })
    });
    const result = await res.json();
    console.log(result);
    loadData();
    form.reset();
    search.value="";
    recordsContainer.style.display="none";
  } catch(e){
    console.error("Error submitting:", e);
  }
});

// Search records
search.addEventListener('input', function(){
  const q = search.value.toLowerCase().trim();
  if(q === ""){
    recordsContainer.style.display="none";
    recordsTable.innerHTML="";
    return;
  }
  const filtered = recordsData.filter(r => r.item.toLowerCase().includes(q));
  recordsTable.innerHTML="";
  if(filtered.length){
    recordsContainer.style.display="block";
    filtered.forEach(r=>{
      recordsTable.innerHTML += `<tr>
        <td>${r.qty}</td><td>${r.action}</td><td>${r.person}</td><td>${r.purpose}</td><td>${r.time}</td>
      </tr>`;
    });
  } else recordsContainer.style.display="none";
});

// Live update every 5 seconds
setInterval(loadData,5000);

// Initial load
loadData();
</script>
</body>
</html>
