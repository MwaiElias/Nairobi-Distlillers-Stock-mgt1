<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Management | Nairobi Distillers</title>
  <style>
    body { font-family: Arial, sans-serif; background: #000; color: #fff; margin: 0; padding: 0; }
    header { background: #111; padding: 20px; text-align: center; font-size: 28px; font-weight: bold; border-bottom: 2px solid #444; }
    .container { max-width: 100%; margin: 20px auto; background: #111; padding: 20px; border-radius: 10px; border: 1px solid #333; overflow-x: auto; }
    h2 { border-left: 4px solid white; padding-left: 10px; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    input, select, button { padding: 10px; border-radius: 5px; border: none; width: 100%; box-sizing: border-box; }
    input, select { background: #222; color: #fff; }
    button { background: #fff; color: #000; font-weight: bold; cursor: pointer; grid-column: span 2; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; border: 1px solid #333; text-align: left; word-break: break-word; }
    th { background: #222; }
    #recordsContainer { display: none; }
    @media (max-width: 600px) { form { grid-template-columns: 1fr; } button { grid-column: span 1; } table, th, td { font-size: 14px; } }
  </style>
</head>
<body>
  <header>Nairobi Distillers | Stock Management System</header>

  <div class="container">
    <h2>Add / Remove Stock</h2>
    <form id="stockForm">
      <input type="text" id="itemName" placeholder="Item" required />
      <input type="number" id="quantity" placeholder="Quantity" required />
      <input type="text" id="person" placeholder="Name" required />
      <input type="text" id="purpose" placeholder="Purpose of Item" required />
      <select id="action" required>
        <option value="add">Add to Stock</option>
        <option value="remove">Remove from Stock</option>
      </select>
      <button type="submit">Submit</button>
    </form>

    <h2>Search / Edit Item Records</h2>
    <input type="text" id="search" placeholder="Enter item name to see all entries" style="width:100%;margin-bottom:10px;background:#222;color:white;padding:10px;border-radius:5px;" />

    <div id="recordsContainer">
      <h2>Stock Records for Item</h2>
      <table>
        <thead>
          <tr>
            <th>Qty</th><th>Action</th><th>Person</th><th>Purpose</th><th>Time</th><th>Edit</th>
          </tr>
        </thead>
        <tbody id="records"></tbody>
      </table>
    </div>

    <h2>Current Stock Balance</h2>
    <table>
      <thead><tr><th>Item</th><th>Balance</th><th>Edit</th></tr></thead>
      <tbody id="balance"></tbody>
    </table>

    <button onclick="exportExcel()">Export Excel</button>
    <button onclick="exportPDF()">Export PDF</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database-compat.js"></script>
  <script>
    // TODO: Replace with your actual Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR-API-KEY",
      authDomain: "YOUR-PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR-PROJECT.firebaseio.com",  // or .firebasedatabase.app
      projectId: "YOUR-PROJECT",
      storageBucket: "YOUR-PROJECT.appspot.com",
      messagingSenderId: "…",
      appId: "…"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const form = document.getElementById('stockForm');
    const recordsTable = document.getElementById('records');
    const recordsContainer = document.getElementById('recordsContainer');
    const balanceTable = document.getElementById('balance');
    const search = document.getElementById('search');

    function refreshUI(recordsObj) {
      // Build balance
      let balance = {};
      Object.values(recordsObj).forEach(r => {
        const item = r.item;
        if (!balance[item]) balance[item] = 0;
        balance[item] += r.action === 'add' ? Number(r.qty) : -Number(r.qty);
      });
      balanceTable.innerHTML = '';
      Object.keys(balance).forEach(item => {
        balanceTable.innerHTML += `<tr><td>${item}</td><td>${balance[item]}</td><td></td></tr>`;
      });
    }

    function renderSearch(recordsObj, query) {
      recordsTable.innerHTML = '';
      let any = false;
      Object.values(recordsObj).forEach((r, index) => {
        if (r.item.toLowerCase().includes(query.toLowerCase())) {
          any = true;
          recordsTable.innerHTML += `<tr>
            <td>${r.qty}</td><td>${r.action}</td><td>${r.person}</td><td>${r.purpose}</td><td>${r.time}</td>
            <td><button onclick="editRecord('${r._id}')">Edit</button></td>
          </tr>`;
        }
      });
      recordsContainer.style.display = any ? 'block' : 'none';
    }

    // Listen for changes
    db.ref('stockRecords').on('value', snapshot => {
      const data = snapshot.val() || {};
      refreshUI(data);
      const q = search.value.trim();
      if (q) renderSearch(data, q);
      else recordsContainer.style.display = 'none';
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const newRecord = {
        item: itemName.value,
        qty: quantity.value,
        action: action.value,
        person: person.value,
        purpose: purpose.value,
        time: new Date().toLocaleString()
      };
      const newRef = db.ref('stockRecords').push();
      newRecord._id = newRef.key;
      newRef.set(newRecord);
      form.reset();
    });

    function editRecord(id) {
      const recRef = db.ref('stockRecords/' + id);
      recRef.once('value').then(snap => {
        const r = snap.val();
        const newQty = prompt('Qty', r.qty);
        const newPerson = prompt('Person', r.person);
        const newPurpose = prompt('Purpose', r.purpose);
        const newAction = prompt('Action (add/remove)', r.action);
        if (newQty !== null) r.qty = newQty;
        if (newPerson !== null) r.person = newPerson;
        if (newPurpose !== null) r.purpose = newPurpose;
        if (newAction === 'add' || newAction === 'remove') r.action = newAction;
        r.time = new Date().toLocaleString();
        recRef.set(r);
      });
    }

    function exportExcel() {
      // implement as needed
    }
    function exportPDF() {
      alert('PDF export coming soon');
    }

    search.addEventListener('input', () => {
      const q = search.value.trim();
      if (!q) {
        recordsContainer.style.display = 'none';
        recordsTable.innerHTML = '';
        return;
      }
      db.ref('stockRecords').once('value').then(snapshot => {
        renderSearch(snapshot.val() || {}, q);
      });
    });
  </script>
</body>
</html>
